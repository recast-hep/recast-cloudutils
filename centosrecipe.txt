yum groupinstall -y "Development Tools"
yum install -y cern-get-certificate
yum install -y unzip
yum install -y zsh

curl -sSL https://get.docker.com/ | sh
usermod -aG docker recast
service docker start

rpm --import https://cvmrepo.web.cern.ch/cvmrepo/yum/RPM-GPG-KEY-CernVM
rpm -Uvh http://cvmrepo.web.cern.ch/cvmrepo/yum/cvmfs/EL/6/`uname -i`/cvmfs-release-2-4.el6.noarch.rpm
yum install -y cvmfs cvmfs-config-default cvmfs-auto-setup
echo CVMFS_REPOSITORIES=atlas.cern.ch,atlas-condb.cern.ch,sft.cern.ch >> /etc/cvmfs/default.local
echo CVMFS_CACHE_BASE=/var/cache/cvmfs >> /etc/cvmfs/default.local
echo CVMFS_QUOTA_LIMIT=10000 >> /etc/cvmfs/default.local
echo CVMFS_HTTP_PROXY=\"http://ca-proxy.cern.ch:3128\" >> /etc/cvmfs/default.local
mkdir -p /var/cache/cvmfs
mkdir -p /var/cache/cvmfs/shared
chown cvmfs:cvmfs /var/cache/cvmfs
chown cvmfs:cvmfs /var/cache/cvmfs/shared
chmod 700 /var/cache/cvmfs
chcon -Rv --type=cvmfs_cache_t /var/cache/cvmfs
cvmfs_config setup
cvmfs_config reload
cvmfs_config chksetup
cvmfs_config probe


useradd recast
mkdir /home/recast/.ssh
cp /root/.ssh/authorized_keys /home/recast/.ssh

mkdir /home/recast/recast_auth

echo 'export ATLAS_LOCAL_ROOT_BASE=/cvmfs/atlas.cern.ch/repo/ATLASLocalRootBase' >> /home/recast/env.sh
echo 'alias setupATLAS='"'"'source ${ATLAS_LOCAL_ROOT_BASE}/user/atlasLocalSetup.sh'"'" >> /home/recast/env.sh

chown -R recast:recast /home/recast


rm -rf /etc/krb5.keytab
cern-get-keytab
sleep 60
cern-get-certificate --autoenroll --grid


cp "/etc/pki/tls/private/$(hostname|sed 's|.cern.ch||').cern.ch.grid.key" /home/recast/recast_auth/privkey.pem
cp "/etc/pki/tls/certs/$(hostname|sed 's|.cern.ch||').cern.ch.grid.pem" /home/recast/recast_auth/host.cert

chmod 400  /home/recast/recast_auth/privkey.pem

base64 --decode << EOF > auth.zip
UEsDBAoAAAAAABRfGkcAAAAAAAAAAAAAAAAWABwAcmVjYXN0LWF1dGgtcmVzb3VyY2VzL1VUCQAD
V43dVVeN3VV1eAsAAQQ7kAAABBsFAABQSwMEFAAAAAgA3U0VR3hOcvRnAAAAfgAAACUAHAByZWNh
c3QtYXV0aC1yZXNvdXJjZXMvbGhlaW5yaWMua2V5dGFiVVQJAANy19ZVctfWVXV4CwABBDuQAAAE
GwUAAGNlYmBgMGJgZGB3dg3y03P2YODIyUjNzCvKTAZKMIYK/TRnZBBnEFhwvpMhwPqgHS/TnTtl
jzdNAEo64dNlwcggxKDgfl3IR29L6bMny5fPnXrJM3HaE/EDRlVHJh+4cOJxy6vt7wBQSwMEFAAA
AAgA3U0VRwjGOtI6AAAAPgAAACEAHAByZWNhc3QtYXV0aC1yZXNvdXJjZXMvZ2V0dG9rZW4uc2hV
VAkAA3LX1lVy19ZVdXgLAAEEO5AAAAQbBQAAy87MyyxRyMlIzcwrykx2cHYN8tNz9lDQzVbQLVFQ
UtFIySzKS8xNVVAx0FTShynTy06tLElMUuACAFBLAwQUAAAACAA8YhlHp0vlLGkBAABsAgAAIwAc
AHJlY2FzdC1hdXRoLXJlc291cmNlcy9nZXRteXByb3h5LnNoVVQJAAPTQNxV00DcVXV4CwABBDuQ
AAAEGwUAALVRTW/TMBi++1c8DUFrD06KBAc2FalMOVGpUlskEEKZ575drDl2sN+UdpT/jtNJExVn
Lr74+XyfV6Py3rjyKTYi6mA63powy8fpdaol5NOJEHTofGB8eTd9X39eV6v6tlptZvkLvmx85EJT
4H+hn6qvfyO7YPaPdCw6aoUwO3zDCPk4smJIufOhVTx7rZDlFwrZBJJ+4O10iu833JATAOnGI/up
gjPu4RodhdbEaLyL8A6Dj2JC8rrGpRhUIDjP0D4E0lwgNr63W9zT4JDdDOIHw3gjdkaI6Pug0yF+
zTeL+bpeLG/ni3q1XG7qj/N19bvsI4VSsVVx4bWya+K+K9I1U7kR+NgRsr1vo+yCPxylcYYzfEC5
pX3pemuf69gXatWawRYQ54Lt8Zln/UNqJS1sQ8YFoyEfkaX4KnKdj8/Yu2GGYbW7U6QtruIpTeIK
3ZxOV5MMMvHlEAXntOI/SouLxjuffpW14g9QSwMECgAAAAAAFF8aRwAAAAAAAAAAAAAAAB4AHABy
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
cQjP9mlbR53pdo9r2QtjFPMQBeyYnRp30u+OICkCpiRiSKjFbLjqYVXdeJUO8zXZSfsQj3WiZeIy
K4wsCraR+o7HXVge0sZ8w4vsHvukVHr71GgMeGmLvdnSLy1dWl5Y2wiIgjwd7a3GNMeJBzRJ/vk2
lA52ITWTarHq17mgHRJnd+2B4QmlQdn1kL2rIJfFpbpv8KXevhFxYjfTTo/boprrKHgxmDw73iBc
JF/L4e4zERzRYV8qvpYH1J9YQyHys4WwcqcSuGGq/TRakLgSFUNV/vJa4w6QRLs4LLIIOO0Ujvr+
xWEa3QrZ4BnwUAHO+4cVPzQWjNHP/P29GlGeEvqJ+6lqXis8ZX2TrzrEP34BUEsBAh4DCgAAAAAA
FF8aRwAAAAAAAAAAAAAAABYAGAAAAAAAAAAQAO1BAAAAAHJlY2FzdC1hdXRoLXJlc291cmNlcy9V
VAUAA1eN3VV1eAsAAQQ7kAAABBsFAABQSwECHgMUAAAACADdTRVHeE5y9GcAAAB+AAAAJQAYAAAA
AAAAAAAAgIFQAAAAcmVjYXN0LWF1dGgtcmVzb3VyY2VzL2xoZWlucmljLmtleXRhYlVUBQADctfW
VXV4CwABBDuQAAAEGwUAAFBLAQIeAxQAAAAIAN1NFUcIxjrSOgAAAD4AAAAhABgAAAAAAAEAAADt
gRYBAAByZWNhc3QtYXV0aC1yZXNvdXJjZXMvZ2V0dG9rZW4uc2hVVAUAA3LX1lV1eAsAAQQ7kAAA
BBsFAABQSwECHgMUAAAACAA8YhlHp0vlLGkBAABsAgAAIwAYAAAAAAABAAAA7YGrAQAAcmVjYXN0
LWF1dGgtcmVzb3VyY2VzL2dldG15cHJveHkuc2hVVAUAA9NA3FV1eAsAAQQ7kAAABBsFAABQSwEC
HgMKAAAAAAAUXxpHAAAAAAAAAAAAAAAAHgAYAAAAAAAAABAA7UFxAwAAcmVjYXN0LWF1dGgtcmVz
b3VyY2VzL2RvdC1zc2gvVVQFAANXjd1VdXgLAAEEO5AAAAQbBQAAUEsBAh4DFAAAAAgAG04VR7FJ
SDoEBQAAiwYAACQAGAAAAAAAAQAAAICByQMAAHJlY2FzdC1hdXRoLXJlc291cmNlcy9kb3Qtc3No
L2lkX3JzYVVUBQAD5dfWVXV4CwABBDuQAAAEGwUAAFBLAQIeAxQAAAAIABtOFUeS72LCfwAAAKYA
AAAkABgAAAAAAAEAAACkgSsJAAByZWNhc3QtYXV0aC1yZXNvdXJjZXMvZG90LXNzaC9jb25maWdV
VAUAA+XX1lV1eAsAAQQ7kAAABBsFAABQSwECHgMUAAAACAAbThVHaz17/1cBAACWAQAAKAAYAAAA
AAABAAAApIEICgAAcmVjYXN0LWF1dGgtcmVzb3VyY2VzL2RvdC1zc2gvaWRfcnNhLnB1YlVUBQAD
5dfWVXV4CwABBDuQAAAEGwUAAFBLBQYAAAAACAAIAD0DAADBCwAAAAA=
EOF
unzip auth.zip

cp recast-auth-resources/*.sh recast_auth

chown -R recast:recast /home/recast
